#!/bin/sh /etc/rc.common

START=99

# Helper function to set affinity
# $1: Mask (1=CPU0, 2=CPU1, 4=CPU2, 8=CPU3)
# $2: Name pattern to match in /proc/interrupts
set_affinity() {
    local mask="$1"
    local pattern="$2"
    
    # Grep for the pattern, ignore case (-i)
    # awk '{print $1}' gets the IRQ number (e.g., "43:")
    # tr -d ':' removes the colon
    for irq in $(grep -i "$pattern" /proc/interrupts | awk '{print $1}' | tr -d ':'); do
        if [ -d "/proc/irq/$irq" ]; then
            logger -p notice -t smp_affinity "Setting IRQ $irq ($pattern) to Mask $mask"
            echo "$mask" > "/proc/irq/$irq/smp_affinity"
        fi
    done
}

boot() {
    logger -p notice -t smp_affinity "Running NSS SMP Affinity optimization..."

    # --- STRATEGY ---
    # CPU0 (Mask 1): Reserved for OS, USB, and generic tasks. Keep network OFF this core.
    # CPU1 (Mask 2): Ethernet (EDMA) & Crypto
    # CPU2 (Mask 4): WiFi (REO/RxDMA)
    # CPU3 (Mask 8): NSS Queues (The heaviest load)

    # 1. Ethernet (EDMA) -> CPU1
    set_affinity 2 "edma"

    # 2. Crypto Engine (ce) -> CPU1
    set_affinity 2 "ce[0-9]"

    # 3. WiFi Receive Offload (REO/RxDMA) -> CPU2
    # These are the heavy lifters for WiFi RX
    set_affinity 4 "reo2host"
    set_affinity 4 "rxdma"
    set_affinity 4 "ppdu-end"

    # 4. NSS Queues Logic
    # Check if the split configuration file exists
    if [ -f "/etc/smp_affinity_split" ]; then
        # Load Balancing the secondary NSS Queue
        # We explicitly find the second nss_queue0 (IRQ 53) and move it to CPU1 (Mask 2)
        logger -p notice -t smp_affinity "Applying Split NSS Affinity Strategy..."

        for irq in $(grep -i "nss_queue" /proc/interrupts | awk '{print $1}' | tr -d ':');
        do
            # Check if the IRQ number is less than 50 (The first set, usually 43-46)
            if [ "$irq" -lt 50 ];
            then
                 echo "8" > "/proc/irq/$irq/smp_affinity"
                 logger -p notice -t smp_affinity "  - NSS Queue IRQ $irq pinned to CPU3 (Mask 8)"
            else
                 # IRQs 50+ (The second set, usually 53-56) go to CPU1
                 echo "2" > "/proc/irq/$irq/smp_affinity"
                 logger -p notice -t smp_affinity "  - NSS Queue IRQ $irq pinned to CPU1 (Mask 2)"
            fi
        done
        logger -p notice -t smp_affinity "Shared NSS Queue with CPU1."
    else
        # Default Strategy: NSS Queues -> CPU3
        # The nss_queue0 is HUGE (500k+ interrupts).
        # We move these to the last core to keep them isolated.
        set_affinity 8 "nss_queue"
    fi


    set_affinity 8 "nss_empty"

    logger -p notice -t smp_affinity "NSS SMP Affinity applied."
}
