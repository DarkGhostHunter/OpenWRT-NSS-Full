#!/bin/sh

PKG_NAME="$1"

# Validation: Check if argument is provided.
: "${PKG_NAME:?Usage: $0 <config_name>}"

CONFIG="/etc/config/$PKG_NAME"
ROM_CONFIG="/rom/etc/config/$PKG_NAME"

# 1. Immediate Check: If active config is missing or empty,
# it effectively needs to be "restored/updated".
if [ ! -s "$CONFIG" ]; then
    exit 0
fi

# 2. Check if ROM config exists to compare against.
# If ROM version doesn't exist, the user created this file manually.
# Therefore, it is NOT default (Exit 1).
if [ ! -f "$ROM_CONFIG" ]; then
    exit 1
fi

# FUNCTION: Normalization Pipeline
# 1. sed 's/#.*//'        -> Removes comments (content after #)
# 2. sed 's/^[ \t]*//'    -> Removes leading whitespace/tabs
# 3. sed 's/[ \t]*$//'    -> Removes trailing whitespace/tabs
# 4. sed '/^$/d'          -> Removes empty lines (leftover from prev steps)
# 5. sort                 -> Sorts alphabetically
# 6. md5sum               -> Hashes the result
# 7. awk '{print $1}'     -> Returns only the hash string
calc_checksum() {
    sed 's/#.*//' "$1" | \
    sed -e 's/^[ \t]*//' -e 's/[ \t]*$//' | \
    sed '/^$/d' | \
    sort | \
    md5sum | awk '{print $1}'
}

# Calculate hashes for both files
SUM_ACTIVE=$(calc_checksum "$CONFIG")
SUM_ROM=$(calc_checksum "$ROM_CONFIG")

# Compare Hashes
if [ "$SUM_ACTIVE" = "$SUM_ROM" ]; then
    exit 0 # Hashes match: File is semantically "Default"
else
    exit 1 # Hashes differ: File is "Customized"
fi