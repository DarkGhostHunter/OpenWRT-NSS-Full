#!/bin/sh

# Configuration
SQM_IFACE="wan"
SAFETY_MARGIN_PERCENT=95
LOG_FILE="/var/log/sqm_autotune.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "Starting SQM Auto-Tune..."

# 1. Check for Internet Connectivity
log "Checking internet connectivity..."
if ! /usr/bin/has-internet; then
    log "ERROR: No internet connection detected. Aborting."
    exit 1
fi

# 2. Check for speedtest tool
if ! command -v speedtest >/dev/null 2>&1; then
    log "ERROR: 'speedtest' command not found. Please install a speedtest package."
    exit 1
fi

# 3. Run Speedtest
log "Running speedtest (this may take 30-60 seconds)..."
SPEED_OUTPUT=$(speedtest 2>&1)

# 4. Parse Output
# Regex looks for lines starting with "Download:" or "Upload:" and captures the float value
DL_RAW=$(echo "$SPEED_OUTPUT" | grep -i "Download" | awk '{print $2}')
UL_RAW=$(echo "$SPEED_OUTPUT" | grep -i "Upload" | awk '{print $2}')

# Check if we got numbers
if [ -z "$DL_RAW" ] || [ -z "$UL_RAW" ]; then
    log "ERROR: Could not parse speedtest output."
    log "Raw output: $SPEED_OUTPUT"
    exit 1
fi

log "Measured Raw Speed: Down: ${DL_RAW} Mbit/s | Up: ${UL_RAW} Mbit/s"

# 5. Calculate SQM Values (95% of measured speed to minimize bufferbloat)
# We use awk for floating point calculation, then printf %.0f to round to nearest integer for UCI
DL_SET=$(awk "BEGIN {printf \"%.0f\", $DL_RAW * 1000 * ($SAFETY_MARGIN_PERCENT / 100)}")
UL_SET=$(awk "BEGIN {printf \"%.0f\", $UL_RAW * 1000 * ($SAFETY_MARGIN_PERCENT / 100)}")

# Validate results are greater than 0
if [ "$DL_SET" -le 0 ] || [ "$UL_SET" -le 0 ]; then
    log "ERROR: Calculated speeds are invalid (0 or less). Aborting."
    exit 1
fi

log "Setting SQM (ingress: $DL_SET kbit/s, egress: $UL_SET kbit/s)"

# 6. Apply to UCI
uci set sqm.${SQM_IFACE}.enabled='1'
uci set sqm.${SQM_IFACE}.download="${DL_SET}"
uci set sqm.${SQM_IFACE}.upload="${UL_SET}"
uci commit sqm

# 7. Restart SQM
if /etc/init.d/sqm restart; then
    log "SQM successfully updated and restarted."
else
    log "WARNING: UCI updated, but SQM service failed to restart."
fi

exit 0
