#!/bin/sh

# ANSI Colors
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
NC="\033[0m" # No Color

show_menu() {
    clear
    printf "%b=========================================%b\n" "${YELLOW}" "${NC}"
    printf "      Firewall Configuration Tool        \n"
    printf "%b=========================================%b\n" "${YELLOW}" "${NC}"
    printf "\n"
    printf "1. Set Firewall Defaults (Secure)\n"
    printf "   Re-applies the default policies for firewall.\n"
    printf "   (Input: REJECT, Output: ACCEPT, Forward: REJECT)\n"
    printf "   Removes any temporary WAN access rules.\n"
    printf "\n"
    printf "2. Enable WAN Management Access\n"
    printf "   Allows SSH, HTTP, HTTPS, SMB, Avahi (Bonjour), btop (via ttyd) and Ping from the WAN side.\n"
    printf "   Enable Plex Media Server, Aria2 (6980-6999), miniDLNA, from the WAN side.\n"
    printf "   Useful for upstream management, client discovery, but keeping the firewall enabled.\n"
    printf "   Firewall will be enabled, and these rules will be enabled (or added if absent).\n"
    printf "\n"
    printf "3. Disable Firewall Completely (DANGEROUS)\n"
    printf "   Stops the firewall service and sets all policies to ACCEPT.\n"
    printf "   Use only if this device is behind another firewall.\n"
    printf "\n"
    printf "0. Exit\n"
    printf "\n"
}

set_defaults() {
    printf "\n%bApplying Firewall Defaults (init.d/z3-firewall base)...%b\n" "${YELLOW}" "${NC}"

    /etc/init.d/firewall enable

    # To work with the default, we can just copy the OpenWRT default firewall config
    # into the current config, then run the init.d/z3-firewall and call it a day.
    cp /rom/etc/config/firewall /etc/config/firewall

    sh -c /rom/etc/init.d/z3-firewall

    /etc/init.d/firewall restart
    printf "%bSecure defaults applied.%b\n" "${GREEN}" "${NC}"
}

allow_wan_management() {
    printf "\n%bEnabling WAN Management Access...%b\n" "${GREEN}" "${NC}"

    /etc/init.d/firewall enable

    # Add the default rules
    /usr/bin/add-management-wan-to-firewall

    # Iterate on each added rule and enable it
    RULES="
allow_ssh_wan
allow_ttyd_management_wan
allow_ttyd_btop_wan
allow_http_management_wan
allow_https_management_wan
allow_avahi_wan
allow_smb_wan
allow_plex_http_wan
allow_plex_discovery_wan
allow_ariang_wan
allow_ariang_bittorrent_wan
allow_minidlna_wan
allow_minidlna_discovery_wan
"

    for rule in $RULES; do
        if uci show "firewall.$rule" >/dev/null 2>&1; then
            uci set "firewall.$rule.enabled='1'"
            printf "%Enabled rule [$rule].%b\n" "${GREEN}" "${NC}"
        else
            printf "%The [$rule] was not found to be enabled. You will have to create it manually %b\n" "${YELLOW}" "${NC}"
        fi
    done

    uci commit firewall
    /etc/init.d/firewall restart

    printf "%bWAN Access Enabled.%b\n" "${GREEN}" "${NC}"
}

disable_firewall() {
    printf "\n%bDisabling Firewall Service...%b\n" "${RED}" "${NC}"

    /etc/init.d/firewall stop
    /etc/init.d/firewall disable

    echo "Flushing tables and setting default policies to ACCEPT..."

    if command -v nft >/dev/null; then
        nft flush ruleset
        nft add table inet filter
        nft add chain inet filter input "{ type filter hook input priority 0 ; policy accept ; }"
        nft add chain inet filter forward "{ type filter hook forward priority 0 ; policy accept ; }"
        nft add chain inet filter output "{ type filter hook output priority 0 ; policy accept ; }"
    else
        iptables -P INPUT ACCEPT
        iptables -P OUTPUT ACCEPT
        iptables -P FORWARD ACCEPT
        iptables -F
        iptables -t nat -F
        iptables -t mangle -F
    fi

    printf "%bFirewall stopped and flushed. ALL TRAFFIC ALLOWED.%b\n" "${RED}" "${NC}"
}

while true; do
    show_menu
    printf "Select an option [0-3]: "
    read -r choice
    case "$choice" in
        1) set_defaults; printf "Press Enter to continue..."; read -r _ ;;
        2) allow_wan_management; printf "Press Enter to continue..."; read -r _ ;;
        3) disable_firewall; printf "Press Enter to continue..."; read -r _ ;;
        0) exit 0 ;;
        *) printf "%bInvalid option.%b\n" "${RED}" "${NC}"; sleep 1 ;;
    esac
done