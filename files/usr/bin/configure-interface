#!/bin/sh

# ANSI Colors
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
NC="\033[0m" # No Color

show_menu() {
    clear
    printf "%b=========================================%b\n" "${YELLOW}" "${NC}"
    printf "      Interface Mode Configuration       \n"
    printf "%b=========================================%b\n" "${YELLOW}" "${NC}"
    printf "\n"
    printf "1. Router Mode (Factory Default)\n"
    printf "   Standard operation: NAT, DHCP Server, DNS (Unbound).\n"
    printf "   LAN IP: 10.0.0.1 (Static)\n"
    printf "\n"
    printf "2. Managed Switch / Dumb AP Mode\n"
    printf "   Bridges WAN to LAN. Gets IP from upstream router.\n"
    printf "   Disables: NAT, Local DHCP, Unbound, Odhcpd, BanIP.\n"
    printf "   Use this to extend an existing network.\n"
    printf "\n"
    printf "0. Exit\n"
    printf "\n"
}

set_router_mode() {
    printf "\n%bReverting to Router Mode...%b\n" "${YELLOW}" "${NC}"
    printf "This will restore Static IP 10.0.0.1 and enable NAT/DHCP/DNS.\n"

    printf "Are you sure? (y/N): "
    read -r confirm
    if [ "$confirm" != "y" ]; then return; fi

    # 1. Remove WAN from Bridge
    # shellcheck disable=SC2046
    BR_SECTION=$(uci show network | grep "name='br-lan'" | cut -d'.' -f2)
    if [ -n "$BR_SECTION" ]; then
        # Quote variable to prevent word splitting
        uci del_list "network.${BR_SECTION}.ports=wan"
    fi

    # 2. Restore LAN Static IP
    uci set network.lan.proto='static'
    uci set network.lan.ipaddr='10.0.0.1'
    uci set network.lan.netmask='255.255.255.0'

    # 3. Restore WAN Interface
    uci set network.wan.proto='dhcp'
    uci set network.wan6.proto='dhcpv6'

    # 4. Enable DHCP Server
    uci delete dhcp.lan.ignore

    uci commit network
    uci commit dhcp

    echo "Re-enabling Unbound and Odhcpd..."
    /etc/init.d/unbound enable
    /etc/init.d/unbound start
    /etc/init.d/odhcpd enable
    /etc/init.d/odhcpd start

    echo "Applying changes... IP will be 10.0.0.1"
    /etc/init.d/network restart

    # Check firewall status and warn if disabled
    if ! /etc/init.d/firewall enabled; then
        printf "\n%bWARNING: The firewall is currently disabled.%b\n" "${RED}" "${NC}"
        printf "You should enable it manually if desired (e.g., using 'configure-firewall' or '/etc/init.d/firewall enable').\n"
    fi

    exit 0
}

set_ap_mode() {
    printf "\n%bConverting to Managed Switch (Dumb AP)...%b\n" "${YELLOW}" "${NC}"
    printf "This will:\n"
    printf "  1. Bridge WAN port to LAN (br-lan).\n"
    printf "  2. Disable WAN routing.\n"
    printf "  3. Set LAN to DHCP Client (gets IP from upstream).\n"
    printf "  4. Disable local DHCP server, DNS (Unbound), odhcpd and BanIP.\n"
    printf "  5. Disable Firewall completely (sets policies to ACCEPT).\n"
    printf "  6. Disable Watchcat.\n"
    printf "%bWARNING: You will lose connection immediately!%b\n" "${RED}" "${NC}"
    printf "%bWARNING: Firewall will be disabled to avoid interference. Configure manually if needed.%b\n" "${YELLOW}" "${NC}"

    printf "Are you sure? (y/N): "
    read -r confirm
    if [ "$confirm" != "y" ]; then return; fi

    # 1. Add WAN to Bridge
    # shellcheck disable=SC2046
    BR_SECTION=$(uci show network | grep "name='br-lan'" | cut -d'.' -f2)
    if [ -n "$BR_SECTION" ]; then
        # Quote variable to prevent word splitting
        uci add_list "network.${BR_SECTION}.ports=wan"
    else
        printf "%bError: Could not find br-lan device.%b\n" "${RED}" "${NC}"
        return
    fi

    # 2. Configure LAN as DHCP Client
    uci set network.lan.proto='dhcp'
    uci -q delete network.lan.ipaddr
    uci -q delete network.lan.netmask

    # 3. Disable WAN Interface logical config, and don't bring it on boot.
    uci set network.wan.proto='none'
    uci set network.wan.disabled='1'
    uci set network.wan.auto='0'
    uci set network.wan6.proto='none'
    uci set network.wan6.disabled='1'
    uci set network.wan6.auto='0'

    # 4. Disable DHCP Server on LAN
    uci set dhcp.lan.ignore='1'

    uci commit network
    uci commit dhcp

    echo "Disabling Unbound and Odhcpd (Not needed in AP mode)..."
    /etc/init.d/unbound stop
    /etc/init.d/unbound disable
    /etc/init.d/odhcpd stop
    /etc/init.d/odhcpd disable

    echo "Disabling BanIP completely..."
    /etc/init.d/banip stop
    /etc/init.d/banip disable

    echo "Disabling Firewall completely..."
    /etc/init.d/firewall stop
    /etc/init.d/firewall disable

    # Flush tables and set default policy to ACCEPT (Replicating configure-firewall logic)
    if command -v nft >/dev/null; then
        echo "Flushing firewall tables (nft)..."
        nft flush ruleset
        nft add table inet filter
        nft add chain inet filter input "{ type filter hook input priority 0 ; policy accept ; }"
        nft add chain inet filter forward "{ type filter hook forward priority 0 ; policy accept ; }"
        nft add chain inet filter output "{ type filter hook output priority 0 ; policy accept ; }"
    else
        echo "Flushing firewall tables (iptables)..."
        iptables -P INPUT ACCEPT
        iptables -P OUTPUT ACCEPT
        iptables -P FORWARD ACCEPT
        iptables -F
        iptables -t nat -F
        iptables -t mangle -F
    fi

    echo "Disabling Watchcat..."
    /etc/init.d/watchat stop
    /etc/init.d/watchat disable

    echo "Applying network changes... Goodbye!"
    /etc/init.d/network restart
    exit 0
}

while true; do
    show_menu
    printf "Select an option [0-2]: "
    read -r choice
    case "$choice" in
        1) set_router_mode ;;
        2) set_ap_mode ;;
        0) exit 0 ;;
        *) printf "%bInvalid option.%b\n" "${RED}" "${NC}"; sleep 1 ;;
    esac
done